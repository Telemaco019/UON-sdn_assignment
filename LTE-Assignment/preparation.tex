\section{Preparation phase}
\begin{figure}[htb]
	\centering
	\includegraphics[width=1\linewidth]{img/preparation-phase.png}
	\label{fig:preparation-phase}
	\caption{the flow of the messages and the nodes involved in the
	handover preparation phase}
\end{figure}

\subsection*{Step 1}
The source eNodeB decides to initiate an Inter-RAT handover to thetarget access network.

Note that at this point both uplink and downlink user data is transmitted through:
\begin{itemize}
	\item Bearer(s) between UE and source eNodeB
	\item GTP\footnote{GPRS Tunneling protocol (GTP) is a IP/UDP based protocol used to
	encapsulate user data when passing through core network (GTP-U) or to carry bearer
	specific signalling traffic between various core network nodes (GTP-C).} tunnel(s)
	between	source eNodeB, Serving GW and PDN GW.
\end{itemize}


\subsection*{Step 2}
\begin{figure}[htb]
	\centering
	\includegraphics[width=0.9\linewidth]{img/2.png}
	\label{fig:2}
\end{figure}
The source eNodeB sends a \emph{Handover Required} message to the
source MME, requesting the CN to establish resources in the target RNC,
target SGSN and the Serving GW. The message is sent through the S1 interface and
it contains the following parameters:
\begin{itemize}
	\item S1AP Cause: it specifies the reason of the message
	\item Target RNC Identifier: it identifies the target RNC
	\item CSG access mode: included only if the target cell is a hybrid cell
	\item CSG ID: included only if the target cell is a CSG\footnote{CSG = closed
	subscriber group of a home eNodeB} or hybrid cell, it	identifies the cell
	\item Source to Target Transparent Container: it carries RRC parameters and
	Radio Bearer information
\end{itemize}


\subsection*{Step 3}
\begin{figure}[htb]
	\centering
	\includegraphics[width=0.9\linewidth]{img/3.png}
	\label{fig:3}
\end{figure}
The source MME determines from the ``Target RNC Identifier'' field that
the type of handover is intra-RAT Handover to UTRAN Iu mode and, if the CSG ID
is included in the message, it checks the UE's CSG subscribtion. If the UE isn't
subscribed to the CSG, then the MME rejects the handover, unless the UE has
emergency bearer services ongoing (in this case the handover to the target RNC is
performed independent of the restrictions).	If the handover isn't rejected then
the MME selects the target SGSN and sends to it	a \emph{Forward Relocation Request}
message through the S3 interface. Some of the parameters included in this message are:
\begin{itemize}
	\item user IMSI
	\item ISR Supported: it indicates if the source MME and the source S-GW are
	able to activate ISR\footnote{ISR = ``idle mode signalling reduction''. When
	this mode is active the network can simultaneously register the UE in a
	routing area that is served by an SGSN and in one or more tracking areas
	that are served by an MME.}
	\item PDN connections: it indicates the active PDN connections
	\item RAN cause: it's the S1AP cause received from the eNodeB
	\item CSG ID: included only if the target cell is a CSG cell or a hybrid cell
	\item CSG Membership Indication: it indicates if the UE is a CSG member. It's
	included only if the target cell is a hybrid cell or if it is a CSG cell and
	there is at least one emergency bearer service
	\item MM context: it includes information on the EPS Bearer\footnote{EPS Bearers
	= Bearers between the UE and the P-GW} contexts
	\item Source to Target Transparent Container
\end{itemize}
 If none of the UE's EPS Bearers is supported by the target SGSN, the source MME
 rejects the handover attempt and sends a Handover Preparation Failure message to the
 Source eNodeB.

\newpage
\subsection*{Step 4}
\begin{figure}[!htb]
	\centering
	\includegraphics[width=0.9\linewidth]{img/4.png}
	\label{fig:4}
\end{figure}
The target SGSN determines if the S-GW has to be relocated. If so,
it selects the target S-GW and sends to it a \emph{Create Session Request message} per
each PDN connection.

After that, the target SGSN establishes the EPS Bearer contexts indicated by
the message received from the MME and deactivates the Bearer contexts which can't be
estabilished.


\subsection*{Step 4a}
The target S-GW allocates its local resources and returns a
\emph{Create Session Response} to the target SGSN.


\subsection*{Step 5}
\begin{figure}[!htb]
	\centering
	\includegraphics[width=0.9\linewidth]{img/5.png}
	\label{fig:5}
\end{figure}
The target SGSN requests the target RNC to establish the radio
network resources (radio access beares - RABs) by sending the
\emph{Relocation Request} message through the Iu-PS interface. Some of the
parameters included in this message are:
\begin{itemize}
	\item Encryption information: it is sent in order to allow data transfer to
	continue in the new UTRAN target cell without requiring a new Authentication
	and Key Agreement (AKA) procedure
	\item RAB to be setup list: for each RAB to be set up it contains information
	such as the RAB ID and other RAB parameters
	\item CSG ID and CSG Membership Indication: included only when provided by
	the the source MME in the \emph{Forward Relocation Request} message
	\item Source RNC to Target RNC Transparent Container: it includes the information
	received from the source eNodeB included in the Source to Target Transparent
	Container field of the \emph{Handover required} message
\end{itemize}
If the target cell is a CSG cell, the target RNC verifies the CSG ID provided
by the target SGSN and rejects the handover if it does not match the CSG ID for
the target cell. If the CSG Membership Indication is "non member", the target
RNC only accepts emergency bearers.



\subsection*{Step 5a}
For each accepted bearer, the target RNC allocates radio and Iu
user plane resources. After that, the target RNC sends back to the SGSN the
\emph{Relocation Request Acknowledge} messages, which contains a list of the
setup bearers and a list of the failed to setup bearers, which will be deactivated
by the SGSN.

After sending the ACK the RNC is prepared to receive downlink GTP
PDUs\footnote{Packets received by a protocol layer are called Service Data Unit
(SDU) while packets output of a layer are called Protocol Data Unit (PDU).}
from the S-GW (or from the target SGSN if Direct Tunnel is not used) for the
accepted bearers.



\subsection*{Step 6}
\begin{figure}[!htb]
	\centering
	\includegraphics[width=0.9\linewidth]{img/6.png}
	\label{fig:6}
\end{figure}
If Indirect Forwarding and relocation of S-GW apply then the
target SGSN sends a \emph{Create Indirect Data Forwarding Tunnel Request}
message to the target S-GW through the S4 interface. If GTP Direct Tunnel is used
then message includes the Target RNC Address, while if Direct Tunnel isn't
used the message includes the SGSN address. In both cases the message also
include the TEIDs\footnote{TEID = Tunnel Endpoint identifier. Each GTP tunnel
is associated with two TEID: one for the downlink and one for the uplink}
for downlink user data forwarding.
\begin{figure}[!htb]
	\centering
	\includegraphics[width=1\linewidth]{img/direct-tunnelling.png}
	\label{fig:direct-tunnelling}
	\caption{Direct tunnelling in a LTE network \protect\cite{direct-tunnelling}}
\end{figure}


\subsection*{Step 6a}
The S-GW responds to the SGSN with a \emph{Create Indirect Data Forwarding Tunnel
Response} message, specifying as parameter the S-GW Address(es) and
the S-GW DL TEID(s) for data forwarding.



\subsection*{Step 7}
\begin{figure}[!htb]
	\centering
	\includegraphics[width=0.9\linewidth]{img/7.png}
	\label{fig:7}
\end{figure}
The target SGSN sends the \emph{Forward Relocation Response} message
to the source MME through the S3 interface. Some of the parameters contained in
the message are:
\begin{itemize}
 \item S-GW change indication: indicates if a new S-GW has been selected
 \item Target to Source Transparent Container: it contains the value of the
  Target RNC to Source RNC Transparent Container received from the target RNC
 \item Address(es) and TEID(s) for User Traffic Data Forwarding: they define
 the destination tunnelling endpoint for forwarded data
 \item Address(es) and TEID(s) for User Traffic Data Forwarding. If 'Indirect
 Forwarding' and relocation of Serving GW apply then this parameter
\end{itemize}



\subsection*{Step 8}
\begin{figure}[!htb]
	\centering
	\includegraphics[width=0.9\linewidth]{img/8.png}
	\label{fig:8}
\end{figure}
If ``Indirect Forwarding'' applies, the Source MME sends the message \emph{Create
Indirect Data Forwarding Tunnel Request} to the S-GW used for indirect forwarding.
The parameters contained in the message are the list of ``Address(es) and TEID(s) for Data
Forwarding'' received in step 7 and the EPS Bearer ID(s).



\subsection*{Step 8a}
The S-GW replies sending message \emph{Create Indirect Data Forwarding Tunnel
Response}, which contains the S-GW Address(es) and the TEID(s) for data
forwarding. Note that the  Indirect Forwarding may be performed via a Serving GW
which is different from the Serving GW used as the anchor point for the UE.
If the S-GW doesn't support data forwarding, the message contains only an appropriate
cause.
